class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        this.gameState = {
            running: true,
            paused: false,
            score: 0,
            lives: 3,
            level: 1,
            lastTime: 0
        };
        
        this.keys = {};
        this.bullets = [];
        this.monsters = [];
        this.particles = [];
        this.powerUps = [];
        
        this.player = new Player(this.canvas.width, this.canvas.height);
        
        this.setupEventListeners();
        this.createStars();
    }
    
    setupEventListeners() {
        document.addEventListener('keydown', (e) => {
            this.keys[e.key] = true;
            if (e.key === 'p' || e.key === 'P') {
                this.gameState.paused = !this.gameState.paused;
            }
            if (e.key === ' ') {
                e.preventDefault();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            this.keys[e.key] = false;
        });
    }
    
    createStars() {
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.width = Math.random() * 3 + 1 + 'px';
            star.style.height = star.style.width;
            star.style.animationDelay = Math.random() * 2 + 's';
            starsContainer.appendChild(star);
        }
    }
    
    spawnMonster() {
        const x = Math.random() * (this.canvas.width - 100) + 50;
        const types = ['basic', 'fast'];
        if (this.gameState.level >= 3 && Math.random() < 0.1) types.push('boss');
        const type = types[Math.floor(Math.random() * types.length)];
        this.monsters.push(new Monster(x, -50, type));
    }
    
    createExplosion(x, y, color, count = 15) {
        for (let i = 0; i < count; i++) {
            const angle = (Math.PI * 2 * i) / count;
            const speed = Math.random() * 5 + 2;
            this.particles.push(new Particle(
                x, y,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                color,
                30 + Math.random() * 20
            ));
        }
    }
    
    checkCollisions() {
        this.bullets.forEach((bullet, bIndex) => {
            if (bullet.color === '#00ffff') {
                this.monsters.forEach((monster, mIndex) => {
                    const dx = bullet.x - monster.x;
                    const dy = bullet.y - monster.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if (distance < monster.size/2 + bullet.size) {
                        this.bullets.splice(bIndex, 1);
                        monster.health--;
                        
                        if (monster.health <= 0) {
                            this.createExplosion(monster.x, monster.y, monster.color);
                            this.monsters.splice(mIndex, 1);
                            this.gameState.score += monster.type === 'boss' ? 100 : monster.type === 'fast' ? 30 : 50;
                        }
                    }
                });
            } else {
                const dx = bullet.x - this.player.x;
                const dy = bullet.y - this.player.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < 20 + bullet.size && this.player.invulnerable <= 0) {
                    this.bullets.splice(bIndex, 1);
                    this.gameState.lives--;
                    this.player.invulnerable = 120;
                    this.createExplosion(this.player.x, this.player.y, '#00ffff');
                    
                    if (this.gameState.lives <= 0) {
                        this.gameOver();
                    }
                }
            }
        });
        
        this.monsters.forEach((monster, mIndex) => {
            const dx = monster.x - this.player.x;
            const dy = monster.y - this.player.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            if (distance < monster.size/2 + 20 && this.player.invulnerable <= 0) {
                this.monsters.splice(mIndex, 1);
                this.gameState.lives--;
                this.player.invulnerable = 120;
                this.createExplosion(monster.x, monster.y, monster.color);
                this.createExplosion(this.player.x, this.player.y, '#00ffff');
                
                if (this.gameState.lives <= 0) {
                    this.gameOver();
                }
            }
        });
    }
    
    update() {
        this.player.update(this.keys);
        this.player.shoot(this.bullets, this.keys);
        
        this.bullets = this.bullets.filter(bullet => {
            bullet.update();
            return bullet.y > -50 && bullet.y < this.canvas.height + 50 && 
                   bullet.x > -50 && bullet.x < this.canvas.width + 50;
        });
        
        this.monsters = this.monsters.filter(monster => {
            monster.update(this.player, this.bullets);
            return monster.y < this.canvas.height + 100;
        });
        
        this.particles = this.particles.filter(particle => {
            particle.update();
            return particle.life > 0;
        });
        
        if (Math.random() < 0.02 + this.gameState.level * 0.005) {
            this.spawnMonster();
        }
        
        if (this.gameState.score > this.gameState.level * 500) {
            this.gameState.level++;
        }
        
        this.checkCollisions();
    }
    
    render() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.bullets.forEach(bullet => bullet.draw(this.ctx));
        this.monsters.forEach(monster => monster.draw(this.ctx));
        this.particles.forEach(particle => particle.draw(this.ctx));
        this.player.draw(this.ctx);
        
        document.getElementById('score').textContent = this.gameState.score;
        document.getElementById('lives').textContent = this.gameState.lives;
        document.getElementById('level').textContent = this.gameState.level;
    }
    
    gameLoop() {
        if (!this.gameState.running) return;
        
        if (!this.gameState.paused) {
            this.update();
        }
        this.render();
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    gameOver() {
        this.gameState.running = false;
        document.getElementById('finalScore').textContent = this.gameState.score;
        document.getElementById('gameOver').style.display = 'block';
    }
    
    restart() {
        this.gameState = {
            running: true,
            paused: false,
            score: 0,
            lives: 3,
            level: 1,
            lastTime: 0
        };
        
        this.player = new Player(this.canvas.width, this.canvas.height);
        this.bullets = [];
        this.monsters = [];
        this.particles = [];
        
        document.getElementById('gameOver').style.display = 'none';
        this.gameLoop();
    }
    
    start() {
        this.gameLoop();
    }
}